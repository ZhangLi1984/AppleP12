<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apple 证书 P12 与 Base64 工具</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/forge/1.3.1/forge.min.js"></script>
    <style>
        :root {
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --primary-light: #e0e7ff;
            --primary-dark: #3730a3;
            --secondary: #475569;
            --secondary-hover: #334155;
            --accent: #0ea5e9;
            --accent-hover: #0284c7;
            --success: #10b981;
            --success-light: #d1fae5;
            --warning: #f59e0b;
            --warning-light: #fef3c7;
            --danger: #ef4444;
            --danger-hover: #dc2626;
            --danger-light: #fee2e2;
            --text-dark: #1e293b;
            --text-mid: #64748b;
            --text-light: #f8fafc;
            --bg-light: #f8fafc;
            --bg-mid: #f1f5f9;
            --border-light: #e2e8f0;
            --border-mid: #cbd5e1;
            --shadow-color: rgba(148, 163, 184, 0.2);
        }
        
        /* Base styles */
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; 
            scroll-padding-top: 5rem;
            background-color: var(--bg-light);
            background-image: 
                radial-gradient(at 80% 20%, rgba(224, 231, 255, 0.4) 0px, transparent 50%),
                radial-gradient(at 20% 80%, rgba(186, 230, 253, 0.4) 0px, transparent 50%);
            background-attachment: fixed;
            color: var(--text-dark);
        }
        
        /* Form elements */
        .form-label { 
            @apply block text-sm font-medium mb-1.5; 
            color: var(--text-dark);
        }
        
        .form-input { 
            @apply block w-full px-3.5 py-2.5 mt-1 border rounded-lg text-sm transition-all duration-200; 
            background-color: white;
            border-color: var(--border-mid);
            color: var(--text-dark);
            box-shadow: 0 1px 2px 0 var(--shadow-color);
        }
        
        .form-input:focus {
            @apply outline-none ring-2 ring-opacity-50;
            border-color: var(--primary);
            ring-color: var(--primary);
        }
        
        .form-input::placeholder {
            color: var(--text-mid);
        }
        
        .form-textarea { 
            @apply block w-full px-3.5 py-2.5 mt-1 border rounded-lg text-sm resize-none transition-all duration-200; 
            background-color: white;
            border-color: var(--border-mid);
            color: var(--text-dark);
            box-shadow: 0 1px 2px 0 var(--shadow-color);
        }
        
        .form-textarea:focus {
            @apply outline-none ring-2 ring-opacity-50;
            border-color: var(--primary);
            ring-color: var(--primary);
        }
        
        /* Buttons */
        .btn { 
            @apply inline-flex items-center justify-center px-4 py-2.5 font-medium text-sm rounded-lg transition-all duration-200; 
            position: relative;
            overflow: hidden;
        }
        
        .btn:active {
            transform: translateY(1px);
        }
        
        .btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        
        .btn-primary { 
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: 0 1px 3px 0 rgba(79, 70, 229, 0.3), 
                        0 1px 2px -1px rgba(79, 70, 229, 0.2),
                        inset 0 1px 0 0 rgba(255, 255, 255, 0.1);
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, var(--primary-hover), var(--primary-dark));
            box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.2), 
                        0 2px 4px -2px rgba(79, 70, 229, 0.1),
                        inset 0 1px 0 0 rgba(255, 255, 255, 0.1);
            transform: translateY(-1px);
        }
        
        .btn-secondary { 
            background: linear-gradient(135deg, var(--secondary), #334155);
            color: white;
            box-shadow: 0 1px 3px 0 rgba(71, 85, 105, 0.3), 
                        0 1px 2px -1px rgba(71, 85, 105, 0.2),
                        inset 0 1px 0 0 rgba(255, 255, 255, 0.1);
        }
        
        .btn-secondary:hover {
            background: linear-gradient(135deg, var(--secondary-hover), #1e293b);
            box-shadow: 0 4px 6px -1px rgba(71, 85, 105, 0.2), 
                        0 2px 4px -2px rgba(71, 85, 105, 0.1),
                        inset 0 1px 0 0 rgba(255, 255, 255, 0.1);
            transform: translateY(-1px);
        }
        
        .btn-danger { 
            background: linear-gradient(135deg, var(--danger), var(--danger-hover));
            color: white;
            box-shadow: 0 1px 3px 0 rgba(239, 68, 68, 0.3), 
                        0 1px 2px -1px rgba(239, 68, 68, 0.2),
                        inset 0 1px 0 0 rgba(255, 255, 255, 0.1);
        }
        
        .btn-danger:hover {
            background: linear-gradient(135deg, var(--danger-hover), #b91c1c);
            box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.2), 
                        0 2px 4px -2px rgba(239, 68, 68, 0.1),
                        inset 0 1px 0 0 rgba(255, 255, 255, 0.1);
            transform: translateY(-1px);
        }
        
        .btn-sm { 
            @apply px-3 py-1.5 text-xs rounded-md; 
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                rgba(255, 255, 255, 0) 0%,
                rgba(255, 255, 255, 0.2) 50%,
                rgba(255, 255, 255, 0) 100%
            );
            transition: left 0.8s cubic-bezier(0.22, 1, 0.36, 1);
        }
        
        .btn:hover::before {
            left: 100%;
        }
        
        /* Info and notification boxes */
        .info-box { 
            @apply p-4 rounded-lg text-sm flex items-start; 
            background-color: rgba(239, 246, 255, 0.8);
            border-left: 4px solid var(--accent);
            color: #1e40af;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            backdrop-filter: blur(8px);
        }
        
        .error-box { 
            @apply p-4 rounded-lg text-white; 
            background: linear-gradient(135deg, var(--danger), var(--danger-hover));
            box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.2), 0 2px 4px -2px rgba(239, 68, 68, 0.1);
        }
        
        .success-box { 
            @apply p-4 rounded-lg text-white; 
            background: linear-gradient(135deg, var(--success), #059669);
            box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.2), 0 2px 4px -2px rgba(16, 185, 129, 0.1);
        }
        
        .info-message-box { 
            @apply p-4 rounded-lg text-white; 
            background: linear-gradient(135deg, var(--accent), var(--accent-hover));
            box-shadow: 0 4px 6px -1px rgba(14, 165, 233, 0.2), 0 2px 4px -2px rgba(14, 165, 233, 0.1);
        }
        
        /* Output and result containers */
        .output-container { 
            @apply p-5 border rounded-lg transition-all duration-300; 
            background-color: white;
            border-color: var(--border-light);
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        
        .output-container:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
        }
        
        .drop-zone { 
            @apply flex flex-col items-center justify-center px-6 pt-5 pb-6 mt-2 border-2 border-dashed rounded-lg cursor-pointer transition-all duration-200; 
            background-color: rgba(241, 245, 249, 0.6);
            border-color: var(--border-mid);
        }
        
        .drop-zone:hover {
            background-color: rgba(224, 231, 255, 0.3);
            border-color: var(--primary);
        }
        
        .drop-zone-active { 
            background-color: rgba(224, 231, 255, 0.5);
            border-color: var(--primary);
        }
        
        .drop-zone-text-container { 
            @apply text-center; 
        }
        
        .drop-zone-text { 
            @apply text-sm; 
            color: var(--text-mid);
        }
        
        .drop-zone-text span {
            color: var(--primary);
            font-weight: 500;
        }
        
        .drop-zone-subtext { 
            @apply text-xs; 
            color: var(--text-mid);
        }
        
        .base64-result-item { 
            @apply mt-4 p-5 border rounded-lg transition-all duration-200; 
            background-color: white;
            border-color: var(--border-light);
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        
        .base64-result-item:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.05);
            transform: translateY(-2px);
        }
        
        /* Section cards */
        .section-card { 
            @apply p-6 sm:p-8 rounded-xl shadow-md border transition-all duration-200 mb-8; 
            background-color: white;
            border-color: var(--border-light);
            position: relative;
            overflow: hidden;
        }
        
        .section-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, var(--primary), var(--accent));
        }
        
        .section-card:hover {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            transform: translateY(-2px);
        }
        
        .section-title { 
            @apply text-xl sm:text-2xl font-semibold mb-6 pb-3 border-b; 
            color: var(--text-dark);
            border-color: var(--border-light);
        }
        
        /* Progress steps */
        .progress-steps { 
            @apply flex items-center justify-between w-full my-6; 
            max-width: 280px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .step { 
            @apply flex flex-col items-center; 
            z-index: 10;
        }
        
        .step-circle { 
            @apply w-8 h-8 flex items-center justify-center rounded-full; 
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .step-active { 
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.3), 0 2px 4px -2px rgba(79, 70, 229, 0.1);
        }
        
        .step-complete { 
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.3), 0 2px 4px -2px rgba(16, 185, 129, 0.1);
        }
        
        .step-inactive { 
            background-color: var(--bg-mid);
            color: var(--text-mid);
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        
        .step-line { 
            @apply flex-1 h-1 mx-4; 
            transition: all 0.3s ease;
            z-index: 5;
        }
        
        .step-line-active { 
            background: linear-gradient(90deg, var(--primary), var(--accent));
        }
        
        .step-line-inactive { 
            background-color: var(--bg-mid);
        }
        
        .step-text { 
            @apply mt-2 text-xs font-medium; 
            color: var(--text-dark);
        }
        
        .check-icon { 
            @apply w-4 h-4 fill-current text-white; 
        }
        
        .copy-btn-success { 
            background: linear-gradient(135deg, var(--success), #059669) !important;
            color: white !important;
            box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.3), 0 2px 4px -1px rgba(16, 185, 129, 0.2) !important;
            transform: translateY(-1px) !important;
            transition: all 0.2s ease-in-out !important;
        }
        
        .copy-btn-success svg {
            animation: pulse 1s ease-in-out 1;
        }
        
        /* Animations */
        @keyframes appear {
            0% { opacity: 0; transform: translateY(-20px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes disappear {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }
        
        @keyframes fadeOut {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-10px); }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .animate-appear {
            animation: appear 0.3s ease-out forwards;
        }
        
        .animate-disappear {
            animation: disappear 0.3s ease-in forwards;
        }
        
        .animate-fade-out {
            animation: fadeOut 0.3s ease-in forwards;
        }
        
        .animate-pulse {
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        /* Shadow and focus utilities */
        .focus-ring {
            @apply focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-opacity-50;
            focus-ring-color: var(--primary);
        }
        
        .shadow-soft {
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        
        .shadow-medium {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        .shadow-hard {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        /* Glassmorphism effects */
        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        /* Custom scrollbars */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(241, 245, 249, 0.5);
            border-radius: 8px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(148, 163, 184, 0.5);
            border-radius: 8px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(79, 70, 229, 0.5);
        }
        
        /* Additional utility classes */
        .text-gradient {
            @apply bg-clip-text text-transparent;
            background-image: linear-gradient(135deg, var(--primary), var(--accent));
        }
        
        code {
            @apply px-1.5 py-0.5 rounded text-xs font-mono;
            background-color: var(--bg-mid);
            color: var(--primary-dark);
        }
        
        .badge {
            @apply inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium;
        }
        
        .badge-primary {
            background-color: var(--primary-light);
            color: var(--primary-dark);
        }
        
        .badge-success {
            background-color: var(--success-light);
            color: var(--success);
        }
        
        .badge-warning {
            background-color: var(--warning-light);
            color: var(--warning);
        }
        
        .file-display {
            @apply flex items-center p-3 rounded-lg;
            background-color: var(--bg-mid);
        }
        
        /* Message area enhancement */
        #message-area > div {
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-8 sm:py-12 px-4">
    
    <div id="message-area" class="fixed top-5 left-1/2 transform -translate-x-1/2 z-50 w-auto min-w-[300px] max-w-[90%] sm:max-w-md hidden">
        </div>

    <div class="max-w-3xl w-full space-y-8">
        <header class="text-center mb-8">
            <div class="inline-flex p-3 mb-4 rounded-full bg-gradient-to-br from-indigo-100 to-blue-100 shadow-soft">
                <div class="bg-white p-2 rounded-full shadow-soft">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-indigo-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 15v5"></path>
                        <path d="M5 15v5"></path>
                        <path d="M19 15v5"></path>
                        <path d="M5 11h14v4H5z"></path>
                        <path d="M8 5h8a2 2 0 0 1 2 2v4H6V7a2 2 0 0 1 2-2z"></path>
                    </svg>
                </div>
            </div>
            <h1 class="text-3xl sm:text-4xl font-extrabold text-gradient mb-3">
                Apple 证书与 Base64 工具
            </h1>
            <p class="text-sm text-slate-600 max-w-xl mx-auto">一站式生成 CSR、P12 文件及进行 Base64 编码，保证数据安全</p>
            <div class="mt-3 inline-flex items-center px-3 py-1.5 rounded-full text-xs font-medium bg-indigo-50 text-indigo-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                </svg>
                所有操作均在浏览器本地执行，文件不会上传到服务器
            </div>
        </header>

        <!-- Progress Indicator -->
        <div class="progress-steps">
            <div class="step">
                <div id="step1-circle" class="step-circle step-active"></div>
            </div>
            <div class="step-line" id="line1-2"></div>
            <div class="step">
                <div id="step2-circle" class="step-inactive"></div>
            </div>
            <div class="step-line" id="line2-3"></div>
            <div class="step">
                <div id="step3-circle" class="step-inactive"></div>
            </div>
        </div>

        <section id="section1" class="section-card">
            <h3 class="section-title">步骤 1: 生成证书签名请求 (CSR) 和私钥</h3>
            <div class="space-y-5">
                <div class="info-box bg-indigo-50 border-indigo-500 text-indigo-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                    </svg>
                    <p>此步骤将生成 CSR 和私钥文件，之后您需要在 Apple Developer Portal 使用 CSR 创建证书</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                <div>
                    <label for="commonName" class="form-label">开发者名称 (Common Name):</label>
                    <input type="text" id="commonName" name="commonName" class="form-input" placeholder="例如: My App Dev">
                </div>
                <div>
                    <label for="emailAddress" class="form-label">邮箱地址:</label>
                    <input type="email" id="emailAddress" name="emailAddress" class="form-input" placeholder="例如: developer@example.com">
                    </div>
                </div>
                <div>
                    <label for="countryName" class="form-label">国家代码 (2字母, 可选):</label>
                    <input type="text" id="countryName" name="countryName" class="form-input" placeholder="例如: US, CN" maxlength="2">
                </div>
                <button id="generateCsrBtn" class="btn btn-primary w-full py-3.5 text-base font-medium">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd" />
                    </svg>
                    生成并下载 CSR 和私钥
                </button>

                <div id="csrDownloadLinkContainer" class="hidden output-container">
                    <h4 class="font-semibold text-slate-800 mb-2 text-base">证书签名请求 (CSR):</h4>
                    <div class="file-display">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-indigo-500" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd" />
                        </svg>
                        <p id="csrFileNameDisplay" class="text-sm text-slate-700 font-medium"></p>
                    </div>
                    <div class="info-box bg-blue-50 border-blue-500 text-blue-700 mt-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                        </svg>
                        <p><strong class="font-semibold">重要提示:</strong> CSR 文件已准备好下载。请访问您的 Apple Developer 账户，在 "Certificates, Identifiers & Profiles" 部分创建一个新的证书，并上传此 CSR 文件。</p>
                    </div>
                </div>
                
                <div id="privateKeyDownloadLinkContainer" class="hidden output-container">
                    <h4 class="font-semibold text-slate-800 mb-2 text-base">私钥 (Private Key):</h4>
                    <div class="file-display">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-amber-500" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd" />
                        </svg>
                        <p id="privateKeyFileNameDisplay" class="text-sm text-slate-700 font-medium"></p>
                    </div>
                     <div class="info-box bg-amber-50 border-amber-500 text-amber-800 mt-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                        <p><strong class="font-semibold">安全警告:</strong> 私钥文件已准备好下载。请务必将其保存在安全的地方。您将在步骤 2 中需要它来生成 P12 文件。不要与任何人分享此密钥。</p>
                    </div>
                </div>
                
                <div class="pt-4 flex justify-end">
                    <button id="goToStep2Btn" class="btn btn-secondary hidden group">
                        继续步骤 2: 生成 P12 文件
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-2 transition-transform duration-200 group-hover:translate-x-1" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M12.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
            </div>
        </section>

        <section id="section2" class="section-card">
            <h3 class="section-title">步骤 2: 生成 P12 文件</h3>
            <div class="space-y-5">
                <div class="info-box">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                    </svg>
                    <p>在 Apple Developer Portal 使用步骤 1 生成的 CSR 创建并下载证书 (`.cer` 文件) 后，请在此处上传该 `.cer` 文件和您在步骤 1 中下载的私钥文件 (`.key` 或 `.pem` 文件)。</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                <div>
                    <label for="certificateFile" class="form-label">上传证书文件 (.cer):</label>
                        <div id="certificateDropZone" class="drop-zone group">
                        <input type="file" id="certificateFile" accept=".cer" class="hidden">
                        <div class="drop-zone-text-container">
                                <svg class="mx-auto h-12 w-12 text-slate-400 group-hover:text-indigo-500 transition-colors" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                </svg>
                                <p class="mt-1 drop-zone-text">将 .cer 文件拖到此处，或 <span>点击选择文件</span></p>
                            <p id="certificateFileName" class="drop-zone-subtext mt-1"></p>
                        </div>
                    </div>
                </div>

                <div>
                        <label for="privateKeyFile" class="form-label">上传私钥文件 (.key 或 .pem):</label>
                         <div id="privateKeyDropZone" class="drop-zone group">
                        <input type="file" id="privateKeyFile" accept=".key,.pem" class="hidden">
                         <div class="drop-zone-text-container">
                                <svg class="mx-auto h-12 w-12 text-slate-400 group-hover:text-indigo-500 transition-colors" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                </svg>
                                <p class="mt-1 drop-zone-text">将 .key/.pem 文件拖到此处，或 <span>点击选择文件</span></p>
                            <p id="privateKeyForP12FileName" class="drop-zone-subtext mt-1"></p>
                        </div>
                    </div>
                </div>
                </div>
                
                <button id="generateP12Btn" class="btn btn-primary w-full py-3.5 text-base font-medium">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd" />
                    </svg>
                    生成 P12 文件
                </button>
                
                <div id="p12Output" class="hidden output-container">
                     <div class="flex items-center p-3 mb-3 bg-green-50 text-green-700 rounded-lg border-l-4 border-green-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-green-500" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                        </svg>
                        <div>
                            <p class="font-semibold">P12 文件已成功生成</p>
                            <p class="text-sm mt-0.5">密码固定为: <span class="font-mono bg-green-100 px-1.5 py-0.5 rounded text-green-800">123</span></p>
                        </div>
                    </div>
                    
                    <div class="pt-3 flex justify-between">
                        <button id="newP12Btn" class="btn btn-secondary btn-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
                            </svg>
                            生成新的 P12
                        </button>
                        <button id="goToStep3Btn" class="btn btn-secondary group">
                            继续步骤 3: Base64 编码
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-2 transition-transform duration-200 group-hover:translate-x-1" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M12.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <section id="section3" class="section-card">
            <div class="flex justify-between items-center mb-6 pb-3 border-b border-slate-200">
                <h3 class="text-xl sm:text-2xl font-semibold text-slate-800">步骤 3: 文件 Base64 编码</h3>
                <button id="clearBase64ResultsBtn" class="btn btn-danger btn-sm hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                    </svg>
                    清除所有结果
                </button>
            </div>
            <div class="space-y-5">
                <div class="info-box">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                    </svg>
                    <p>上传一个或多个文件 (例如: <code>p12</code>, <code>mobileprovision</code>, <code>txt</code> 等) 以生成其 Base64 编码字符串。</p>
                </div>
                <div>
                    <label for="base64FilesInput" class="form-label">上传文件进行 Base64 编码:</label>
                    <div id="base64DropZone" class="drop-zone group">
                        <input type="file" id="base64FilesInput" multiple class="hidden">
                        <div class="drop-zone-text-container">
                            <svg class="mx-auto h-12 w-12 text-slate-400 group-hover:text-indigo-500 transition-colors" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                                <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                            <p class="mt-1 drop-zone-text">将文件拖到此处，或 <span>点击选择文件</span> (可多选)</p>
                            <p id="base64FileNames" class="drop-zone-subtext mt-1"></p>
                        </div>
                    </div>
                </div>
                <div id="base64ResultsContainer" class="output-container hidden space-y-4">
                    <!-- Results will be inserted here -->
                    </div>
            </div>
        </section>
        <footer class="text-center mt-10 py-4 flex flex-col items-center">
            <p class="text-xs text-slate-500">&copy; 2024 Apple 证书与 Base64 工具</p>
        </footer>
    </div>

    <script>
        const forge = window.forge;
        
        // Progress indicator and section navigation
        const step1Circle = document.getElementById('step1-circle');
        const step2Circle = document.getElementById('step2-circle');
        const step3Circle = document.getElementById('step3-circle');
        const line1_2 = document.getElementById('line1-2');
        const line2_3 = document.getElementById('line2-3');
        const section1 = document.getElementById('section1');
        const section2 = document.getElementById('section2');
        const section3 = document.getElementById('section3');
        const goToStep2Btn = document.getElementById('goToStep2Btn');
        const goToStep3Btn = document.getElementById('goToStep3Btn');
        
        // Initialize progress indicator
        function updateProgressIndicator(step) {
            // Reset all steps
            [step1Circle, step2Circle, step3Circle].forEach(circle => {
                circle.classList.remove('step-active', 'step-complete', 'step-inactive');
                circle.classList.add('step-inactive');
                circle.innerHTML = ''; // Remove any content
            });
            
            [line1_2, line2_3].forEach(line => {
                line.classList.remove('step-line-active', 'step-line-inactive');
                line.classList.add('step-line-inactive');
            });
            
            // Set current step and completed steps
            if (step >= 1) {
                step1Circle.classList.remove('step-inactive');
                step1Circle.classList.add('step-active');
            }
            
            if (step >= 2) {
                step1Circle.classList.remove('step-active');
                step1Circle.classList.add('step-complete');
                step1Circle.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="check-icon" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                </svg>`;
                step2Circle.classList.remove('step-inactive');
                step2Circle.classList.add('step-active');
                line1_2.classList.remove('step-line-inactive');
                line1_2.classList.add('step-line-active');
            }
            
            if (step >= 3) {
                step2Circle.classList.remove('step-active');
                step2Circle.classList.add('step-complete');
                step2Circle.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="check-icon" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                </svg>`;
                step3Circle.classList.remove('step-inactive');
                step3Circle.classList.add('step-active');
                line2_3.classList.remove('step-line-inactive');
                line2_3.classList.add('step-line-active');
            }
        }
        
        // Navigate between sections
        goToStep2Btn.addEventListener('click', () => {
            updateProgressIndicator(2);
            section2.scrollIntoView({ behavior: 'smooth' });
        });
        
        goToStep3Btn?.addEventListener('click', () => {
            // Use the same approach as in processBase64Files to avoid checkmarks
            step1Circle.classList.remove('step-active', 'step-complete', 'step-inactive');
            step1Circle.classList.add('step-inactive');
            step1Circle.innerHTML = '';
            
            step2Circle.classList.remove('step-active', 'step-complete', 'step-inactive');
            step2Circle.classList.add('step-inactive');
            step2Circle.innerHTML = '';
            
            step3Circle.classList.remove('step-active', 'step-complete', 'step-inactive');
            step3Circle.classList.add('step-active');
            step3Circle.innerHTML = '';
            
            // Make the lines inactive
            line1_2.classList.remove('step-line-active');
            line1_2.classList.add('step-line-inactive');
            
            line2_3.classList.remove('step-line-active');
            line2_3.classList.add('step-line-inactive');
            
            section3.scrollIntoView({ behavior: 'smooth' });
        });
        
        // Click handlers for step indicators
        step1Circle.addEventListener('click', () => {
            // Reset all steps to inactive
            step1Circle.classList.remove('step-active', 'step-complete', 'step-inactive');
            step1Circle.classList.add('step-active');
            step1Circle.innerHTML = '';
            
            step2Circle.classList.remove('step-active', 'step-complete', 'step-inactive');
            step2Circle.classList.add('step-inactive');
            step2Circle.innerHTML = '';
            
            step3Circle.classList.remove('step-active', 'step-complete', 'step-inactive');
            step3Circle.classList.add('step-inactive');
            step3Circle.innerHTML = '';
            
            // Make the lines inactive
            line1_2.classList.remove('step-line-active');
            line1_2.classList.add('step-line-inactive');
            
            line2_3.classList.remove('step-line-active');
            line2_3.classList.add('step-line-inactive');
            
            section1.scrollIntoView({ behavior: 'smooth' });
        });
        
        step2Circle.addEventListener('click', () => {
            // Reset all steps to inactive, set step 2 to active
            step1Circle.classList.remove('step-active', 'step-complete', 'step-inactive');
            step1Circle.classList.add('step-inactive');
            step1Circle.innerHTML = '';
            
            step2Circle.classList.remove('step-active', 'step-complete', 'step-inactive');
            step2Circle.classList.add('step-active');
            step2Circle.innerHTML = '';
            
            step3Circle.classList.remove('step-active', 'step-complete', 'step-inactive');
            step3Circle.classList.add('step-inactive');
            step3Circle.innerHTML = '';
            
            // Make the lines inactive
            line1_2.classList.remove('step-line-active');
            line1_2.classList.add('step-line-inactive');
            
            line2_3.classList.remove('step-line-active');
            line2_3.classList.add('step-line-inactive');
            
            section2.scrollIntoView({ behavior: 'smooth' });
        });
        
        step3Circle.addEventListener('click', () => {
            // Reset all steps to inactive, set step 3 to active
            step1Circle.classList.remove('step-active', 'step-complete', 'step-inactive');
            step1Circle.classList.add('step-inactive');
            step1Circle.innerHTML = '';
            
            step2Circle.classList.remove('step-active', 'step-complete', 'step-inactive');
            step2Circle.classList.add('step-inactive');
            step2Circle.innerHTML = '';
            
            step3Circle.classList.remove('step-active', 'step-complete', 'step-inactive');
            step3Circle.classList.add('step-active');
            step3Circle.innerHTML = '';
            
            // Make the lines inactive
            line1_2.classList.remove('step-line-active');
            line1_2.classList.add('step-line-inactive');
            
            line2_3.classList.remove('step-line-active');
            line2_3.classList.add('step-line-inactive');
            
            section3.scrollIntoView({ behavior: 'smooth' });
        });

        function generateRandomString(length, characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789') {
            let result = '';
            for (let i = 0; i < length; i++) {
                result += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            return result;
        }
        
        function generateUUID() { 
            return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
                (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
            );
        }

        function generateRandomCommonName() {
            const uuid = generateUUID();
            const prefix = uuid.split('-')[0];
            return `Dev-${prefix.toUpperCase()}`;
        }

        function generateRandomEmail() {
            const domains = ["gmail.com", "163.com", "outlook.com", "yahoo.com", "icloud.com", "protonmail.com", "zoho.com", "aol.com", "yandex.com", "gmx.com"];
            return `user${Math.floor(Math.random() * 100000)}@${domains[Math.floor(Math.random() * domains.length)]}`;
        }

        function generateRandomCountryCode() {
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            return generateRandomString(2, characters);
        }

        function prefillStep1Inputs() {
            document.getElementById('commonName').value = generateRandomCommonName();
            document.getElementById('emailAddress').value = generateRandomEmail();
            document.getElementById('countryName').value = generateRandomCountryCode();
        }

        function downloadFile(filename, content, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function showMessage(type, text, actionType = 'general') {
            const messageArea = document.getElementById('message-area');
            let boxClass = '';
            let icon = '';
            
            if (type === 'error') {
                boxClass = 'error-box';
                icon = `<div class="flex-shrink-0 w-10 h-10 flex items-center justify-center rounded-full bg-red-100 mr-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-600" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                    </svg>
                </div>`;
            } else if (type === 'success') {
                boxClass = 'success-box';
                icon = `<div class="flex-shrink-0 w-10 h-10 flex items-center justify-center rounded-full bg-green-100 mr-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-600" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                    </svg>
                </div>`;
            } else {
                boxClass = 'info-message-box';
                icon = `<div class="flex-shrink-0 w-10 h-10 flex items-center justify-center rounded-full bg-blue-100 mr-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-600" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                    </svg>
                </div>`;
            }
            
            messageArea.innerHTML = `<div class="${boxClass} flex items-center shadow-xl">${icon}<div>${text}</div></div>`;
            messageArea.classList.remove('hidden');
            
            // Add animation classes
            messageArea.firstChild.classList.add('animate-appear');
            
            setTimeout(() => {
                // Add animation for disappearing
                messageArea.firstChild.classList.add('animate-disappear');

            setTimeout(() => {
                messageArea.classList.add('hidden');
                    messageArea.innerHTML = '';
                }, 300); // Match with CSS animation duration
            }, 4000);
        }
        
        // Add animation styles
        const style = document.createElement('style');
        style.textContent = `
            @keyframes appear {
                0% { opacity: 0; transform: translateY(-20px); }
                100% { opacity: 1; transform: translateY(0); }
            }
            @keyframes disappear {
                0% { opacity: 1; transform: translateY(0); }
                100% { opacity: 0; transform: translateY(-20px); }
            }
            .animate-appear {
                animation: appear 0.3s ease-out forwards;
            }
            .animate-disappear {
                animation: disappear 0.3s ease-in forwards;
            }
        `;
        document.head.appendChild(style);
        
        document.getElementById('generateCsrBtn').addEventListener('click', () => {
            const commonName = document.getElementById('commonName').value.trim();
            const emailAddress = document.getElementById('emailAddress').value.trim();
            const countryName = document.getElementById('countryName').value.trim().toUpperCase();

            if (!commonName || !emailAddress) {
                showMessage('error', '开发者名称和邮箱地址不能为空。');
                return;
            }
            
            // Add loading state to button
            const generateCsrBtn = document.getElementById('generateCsrBtn');
            const originalBtnText = generateCsrBtn.innerHTML;
            generateCsrBtn.innerHTML = `
                <div class="flex items-center justify-center">
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span>生成中...</span>
                </div>
            `;
            generateCsrBtn.disabled = true;
            generateCsrBtn.classList.add('opacity-80', 'cursor-not-allowed');
            
            try {
                setTimeout(() => { // Simulate processing time
                const keys = forge.pki.rsa.generateKeyPair({ bits: 2048 });
                const privateKeyPem = forge.pki.privateKeyToPem(keys.privateKey);
                const csr = forge.pki.createCertificationRequest();
                csr.publicKey = keys.publicKey;
                const subject = [{ name: 'commonName', value: commonName }, { name: 'emailAddress', value: emailAddress }];
                if (countryName && countryName.length === 2) {
                    subject.push({ name: 'countryName', value: countryName });
                } else if (countryName) {
                    showMessage('info', '国家代码无效，已忽略。它应该是2个字母。');
                }
                csr.setSubject(subject);
                csr.sign(keys.privateKey, forge.md.sha256.create());
                const csrPem = forge.pki.certificationRequestToPem(csr);
                const csrFilename = `${commonName.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_.-]/g, '') || 'certificate'}.csr`;
                downloadFile(csrFilename, csrPem, 'application/pkcs10');
                document.getElementById('csrFileNameDisplay').textContent = `已下载: ${csrFilename}`;
                document.getElementById('csrDownloadLinkContainer').classList.remove('hidden');
                const privateKeyFilename = `${commonName.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_.-]/g, '') || 'private'}.key`;
                downloadFile(privateKeyFilename, privateKeyPem, 'application/x-pem-file');
                document.getElementById('privateKeyFileNameDisplay').textContent = `已下载: ${privateKeyFilename}`;
                document.getElementById('privateKeyDownloadLinkContainer').classList.remove('hidden');
                showMessage('success', 'CSR 和私钥文件已生成并开始下载！');
                    
                    // Show the next step button
                    goToStep2Btn.classList.remove('hidden');
                    
                    // Restore button state
                    generateCsrBtn.innerHTML = originalBtnText;
                    generateCsrBtn.disabled = false;
                    generateCsrBtn.classList.remove('opacity-80', 'cursor-not-allowed');
                }, 800);
            } catch (error) {
                console.error("CSR Generation Error:", error);
                showMessage('error', `生成 CSR/私钥失败: ${error.message}`);
                
                // Restore button state
                generateCsrBtn.innerHTML = originalBtnText;
                generateCsrBtn.disabled = false;
                generateCsrBtn.classList.remove('opacity-80', 'cursor-not-allowed');
            }
        });

        function setupDropZone(dropZoneElement, fileInputElement, fileNameDisplayElement, expectedExtension, secondaryExtension = null, allowMultiple = false) {
            // Highlight the drop zone on hover
            dropZoneElement.addEventListener('click', () => fileInputElement.click());
            
            dropZoneElement.addEventListener('dragover', (e) => { 
                e.preventDefault(); 
                dropZoneElement.classList.add('drop-zone-active'); 
            });
            
            dropZoneElement.addEventListener('dragleave', () => { 
                dropZoneElement.classList.remove('drop-zone-active'); 
            });
            
            dropZoneElement.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZoneElement.classList.remove('drop-zone-active');
                handleFiles(e.dataTransfer.files, fileInputElement, fileNameDisplayElement, expectedExtension, secondaryExtension, allowMultiple);
            });
            
            fileInputElement.addEventListener('change', (e) => {
                handleFiles(e.target.files, fileInputElement, fileNameDisplayElement, expectedExtension, secondaryExtension, allowMultiple);
            });
        }
        
        function handleFiles(files, fileInputElement, fileNameDisplayElement, expectedExtension, secondaryExtension, allowMultiple) {
            if (files.length > 0) {
                if (!allowMultiple && files.length > 1) {
                    showMessage('error', '此区域只允许上传单个文件。');
                    fileNameDisplayElement.textContent = '';
                    fileInputElement.value = ''; 
                    return;
                }
                
                let allFilesValid = true;
                let displayFileNames = [];
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    if (expectedExtension === '*' || file.name.endsWith(expectedExtension) || (secondaryExtension && file.name.endsWith(secondaryExtension))) {
                        displayFileNames.push(file.name);
                    } else {
                        allFilesValid = false;
                        const validExtensions = (expectedExtension === '*') 
                            ? "任何文件类型" 
                            : (secondaryExtension ? `${expectedExtension} 或 ${secondaryExtension}` : expectedExtension);
                        showMessage('error', `文件 "${file.name}" 类型无效。请上传 ${validExtensions} 文件。`);
                        break; 
                    }
                }
                
                if (allFilesValid) {
                    fileInputElement.files = files;
                    
                    // Show filenames with icons
                    if (displayFileNames.length === 1) {
                        fileNameDisplayElement.innerHTML = `
                            <span class="inline-flex items-center text-xs font-medium text-slate-700 bg-slate-100 rounded-full px-3 py-1 mt-1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 mr-1.5 text-slate-500" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd" />
                                </svg>
                                ${displayFileNames[0]}
                            </span>
                        `;
                    } else if (displayFileNames.length > 1) {
                        fileNameDisplayElement.innerHTML = `
                            <span class="inline-flex items-center text-xs font-medium text-slate-700 bg-slate-100 rounded-full px-3 py-1 mt-1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 mr-1.5 text-slate-500" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM2 11a2 2 0 012-2h12a2 2 0 012 2v4a2 2 0 01-2 2H4a2 2 0 01-2-2v-4z" />
                                </svg>
                                已选择 ${displayFileNames.length} 个文件
                            </span>
                        `;
                    }
                    
                    if (fileInputElement.id === 'base64FilesInput') {
                        processBase64Files(files);
                    } else {
                        showMessage('success', `文件已成功选择。`, 'info');
                    }
                } else {
                    fileNameDisplayElement.textContent = '';
                    fileInputElement.value = '';
                }
            } else {
                 fileNameDisplayElement.textContent = '';
            }
        }

        setupDropZone(document.getElementById('certificateDropZone'), document.getElementById('certificateFile'), document.getElementById('certificateFileName'), '.cer', null, false);
        setupDropZone(document.getElementById('privateKeyDropZone'), document.getElementById('privateKeyFile'), document.getElementById('privateKeyForP12FileName'), '.key', '.pem', false);
        setupDropZone(document.getElementById('base64DropZone'), document.getElementById('base64FilesInput'), document.getElementById('base64FileNames'), '*', null, true);

        document.getElementById('generateP12Btn').addEventListener('click', () => {
            const certificateFile = document.getElementById('certificateFile').files[0];
            const privateKeyFile = document.getElementById('privateKeyFile').files[0];
            const p12Password = "123";
            
            if (!certificateFile) { 
                showMessage('error', '请上传 .cer 证书文件。'); 
                document.getElementById('certificateDropZone').classList.add('border-red-500', 'bg-red-50');
                setTimeout(() => {
                    document.getElementById('certificateDropZone').classList.remove('border-red-500', 'bg-red-50');
                }, 2000);
                return; 
            }
            
            if (!privateKeyFile) { 
                showMessage('error', '请上传您的 .key 或 .pem 私钥文件。'); 
                document.getElementById('privateKeyDropZone').classList.add('border-red-500', 'bg-red-50');
                setTimeout(() => {
                    document.getElementById('privateKeyDropZone').classList.remove('border-red-500', 'bg-red-50');
                }, 2000);
                return; 
            }
            
            // Add loading state to button
            const generateP12Btn = document.getElementById('generateP12Btn');
            const originalBtnText = generateP12Btn.innerHTML;
            generateP12Btn.innerHTML = `
                <div class="flex items-center justify-center">
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span>生成中...</span>
                </div>
            `;
            generateP12Btn.disabled = true;
            generateP12Btn.classList.add('opacity-80', 'cursor-not-allowed');
            
            const certReader = new FileReader();
            const keyReader = new FileReader();
            let certificateContent, privateKeyPem;
            
            certReader.onload = function(e_cert) {
                certificateContent = e_cert.target.result;
                keyReader.readAsText(privateKeyFile);
            };
            
            certReader.onerror = function() { 
                showMessage('error', '读取证书文件失败。'); 
                // Restore button state
                generateP12Btn.innerHTML = originalBtnText;
                generateP12Btn.disabled = false;
            };
            
            keyReader.onload = function(e_key) {
                privateKeyPem = e_key.target.result;
                
                setTimeout(() => { // Add a slight delay for UX
                try {
                    const certificateAsn1 = forge.asn1.fromDer(certificateContent);
                    const certificate = forge.pki.certificateFromAsn1(certificateAsn1);
                    const privateKey = forge.pki.privateKeyFromPem(privateKeyPem);
                        
                        if (!privateKey) { 
                            showMessage('error', '无法解析私钥文件。请确保它是有效的 PEM 格式 .key 或 .pem 文件。'); 
                            // Restore button state
                            generateP12Btn.innerHTML = originalBtnText;
                            generateP12Btn.disabled = false;
                            return; 
                        }
                        
                        const p12Asn1 = forge.pkcs12.toPkcs12Asn1(
                            privateKey, 
                            certificate, 
                            p12Password, 
                            { algorithm: 'pbeWithSHAAnd3KeyTripleDES', count: 50000 }
                        );
                    const p12Der = forge.asn1.toDer(p12Asn1).getBytes();
                    downloadFile('certificate.p12', p12Der, 'application/x-pkcs12');
                    document.getElementById('p12Output').classList.remove('hidden');
                    showMessage('success', 'P12 文件已成功生成并开始下载。密码为 "123"。');
                        
                        // Update progress indicator
                        updateProgressIndicator(2);
                        
                        // Add smooth scrolling
                        setTimeout(() => {
                            document.getElementById('p12Output').scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }, 300);
                        
                        // Restore button state
                        generateP12Btn.innerHTML = originalBtnText;
                        generateP12Btn.disabled = false;
                        
                } catch (error) {
                    console.error("P12 Generation Error:", error);
                    let errMessage = `生成 P12 文件失败: ${error.message}. `;
                        
                        if (error.message && error.message.includes("Invalid PEM")) {
                            errMessage += "请检查私钥文件格式。";
                            document.getElementById('privateKeyDropZone').classList.add('border-red-500', 'bg-red-50');
                            setTimeout(() => {
                                document.getElementById('privateKeyDropZone').classList.remove('border-red-500', 'bg-red-50');
                            }, 2000);
                        } else if (error.message && (error.message.includes("decode") || error.message.includes("DER"))) {
                            errMessage += "请检查 .cer 文件。";
                            document.getElementById('certificateDropZone').classList.add('border-red-500', 'bg-red-50');
                            setTimeout(() => {
                                document.getElementById('certificateDropZone').classList.remove('border-red-500', 'bg-red-50');
                            }, 2000);
                        }
                        
                    showMessage('error', errMessage);
                        
                        // Restore button state
                        generateP12Btn.innerHTML = originalBtnText;
                        generateP12Btn.disabled = false;
                    }
                }, 800);
            };
            
            keyReader.onerror = function() { 
                showMessage('error', '读取私钥文件失败。'); 
                // Restore button state
                generateP12Btn.innerHTML = originalBtnText;
                generateP12Btn.disabled = false;
            };
            
            certReader.readAsArrayBuffer(certificateFile);
        });

        // New P12 button handler
        document.getElementById('newP12Btn')?.addEventListener('click', () => {
            document.getElementById('certificateFile').value = '';
            document.getElementById('privateKeyFile').value = '';
            document.getElementById('certificateFileName').textContent = '';
            document.getElementById('privateKeyForP12FileName').textContent = '';
            document.getElementById('p12Output').classList.add('hidden');
            showMessage('info', '请上传新的证书和私钥文件以生成另一个 P12 文件。', 'info');
        });

        function arrayBufferToBase64(buffer) {
            let binary = '';
            const bytes = new Uint8Array(buffer);
            for (let i = 0; i < bytes.byteLength; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return window.btoa(binary);
        }

        const base64ResultsContainer = document.getElementById('base64ResultsContainer');
        const clearBase64ResultsBtn = document.getElementById('clearBase64ResultsBtn');

        function processBase64Files(files) {
            // For new uploads, it's better to clear previous results from a previous upload batch.
            const isNewBatch = document.getElementById('base64FilesInput').value !== '';
            if (isNewBatch) {
                // Don't clear
            } else {
                 base64ResultsContainer.innerHTML = '';
            }


            base64ResultsContainer.classList.remove('hidden');
            clearBase64ResultsBtn.classList.remove('hidden');
            let filesProcessedCount = 0;
            let totalProcessed = 0;

            if (files.length === 0 && base64ResultsContainer.children.length === 0) { // Hide if no files and no existing results
                base64ResultsContainer.classList.add('hidden');
                clearBase64ResultsBtn.classList.add('hidden');
                document.getElementById('base64FileNames').textContent = ''; // Clear file names display
                return;
            }
            
            // Update active step indicator without showing green check marks for previous steps
            step1Circle.classList.remove('step-active', 'step-complete', 'step-inactive');
            step1Circle.classList.add('step-inactive');
            step1Circle.innerHTML = '';
            
            step2Circle.classList.remove('step-active', 'step-complete', 'step-inactive');
            step2Circle.classList.add('step-inactive');
            step2Circle.innerHTML = '';
            
            step3Circle.classList.remove('step-active', 'step-complete', 'step-inactive');
            step3Circle.classList.add('step-active');
            step3Circle.innerHTML = '';
            
            // Make the lines inactive
            line1_2.classList.remove('step-line-active');
            line1_2.classList.add('step-line-inactive');
            
            line2_3.classList.remove('step-line-active');
            line2_3.classList.add('step-line-inactive');
            
            // Create processing indicator
            const processingIndicator = document.createElement('div');
            processingIndicator.id = 'processingIndicator';
            processingIndicator.className = 'bg-indigo-50 text-indigo-700 rounded-lg p-4 flex items-center shadow-sm border border-indigo-100';
            processingIndicator.innerHTML = `
                <div class="mr-4 bg-indigo-100 p-2 rounded-full">
                    <svg class="animate-spin h-6 w-6 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </div>
                <div>
                    <p class="font-medium text-indigo-800">正在处理 ${files.length} 个文件...</p>
                    <div class="mt-1 w-full bg-indigo-200 rounded-full h-2.5 overflow-hidden">
                        <div id="progress-bar" class="bg-indigo-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <p class="text-xs mt-1 text-indigo-600"><span id="processedCount">0</span> / ${files.length} 完成</p>
                </div>
            `;
            
            base64ResultsContainer.appendChild(processingIndicator);
            
            showMessage('info', `正在处理 ${files.length} 个文件...`, 'info');

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const base64String = arrayBufferToBase64(e.target.result);
                    const resultId = `base64-${file.name.replace(/[^a-zA-Z0-9]/g, '')}-${Date.now()}-${i}`;
                    const resultItem = document.createElement('div');
                    resultItem.className = 'base64-result-item';
                    
                    // Get appropriate file icon
                    let fileIcon = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-500" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd" />
                        </svg>
                    `;
                    
                    if (file.name.endsWith('.p12')) {
                        fileIcon = `
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-indigo-500" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd" />
                            </svg>
                        `;
                    } else if (file.name.endsWith('.mobileprovision')) {
                        fileIcon = `
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-500" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M10 2a5 5 0 00-5 5v2a2 2 0 00-2 2v5a2 2 0 002 2h10a2 2 0 002-2v-5a2 2 0 00-2-2H7V7a3 3 0 015.905-.75 1 1 0 001.937-.5A5.002 5.002 0 0010 2z" />
                            </svg>
                        `;
                    } else if (file.name.endsWith('.cer') || file.name.endsWith('.pem') || file.name.endsWith('.key')) {
                        fileIcon = `
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-500" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                            </svg>
                        `;
                    }
                    
                    // Get file type for badge
                    let fileType = file.name.split('.').pop() || 'file';
                    let fileTypeBadge = '';
                    
                    // Style the badge based on file type
                    let badgeColor = 'bg-slate-100 text-slate-800';
                    if (fileType === 'p12') badgeColor = 'bg-indigo-100 text-indigo-800';
                    else if (fileType === 'mobileprovision') badgeColor = 'bg-blue-100 text-blue-800';
                    else if (fileType === 'cer' || fileType === 'pem' || fileType === 'key') badgeColor = 'bg-green-100 text-green-800';
                    
                    fileTypeBadge = `<span class="badge ml-2 ${badgeColor}">${fileType}</span>`;
                    
                    resultItem.innerHTML = `
                        <div class="flex justify-between items-center mb-3">
                            <div class="flex items-center">
                                ${fileIcon}
                                <h5 class="font-medium text-slate-800 truncate max-w-[240px] sm:max-w-xs ml-2" title="${file.name}">
                                    ${file.name}
                                    ${fileTypeBadge}
                                </h5>
                                <span class="ml-2 text-xs px-2 py-0.5 bg-slate-100 rounded-full text-slate-600">${(file.size / 1024).toFixed(2)} KB</span>
                        </div>
                            <button onclick="deleteBase64Result(this.parentNode.parentNode)" class="text-slate-400 hover:text-red-500 transition-colors p-1 rounded-full hover:bg-red-50" title="删除结果">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                        <div class="relative">
                            <textarea id="${resultId}" rows="3" class="form-textarea mt-1 w-full text-xs font-mono" readonly>${base64String}</textarea>
                            <div class="absolute top-0 right-0 mt-1 mr-1">
                                <button onclick="copyBase64ToClipboard('${resultId}', '${file.name}')" id="copyBtn-${resultId}" class="btn btn-primary btn-sm shadow-md px-3 py-2 flex items-center" title="复制 Base64">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                        <path d="M8 2a1 1 0 000 2h2a1 1 0 100-2H8z" />
                                        <path d="M3 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v6h-4.586l1.293-1.293a1 1 0 00-1.414-1.414l-3 3a1 1 0 000 1.414l3 3a1 1 0 001.414-1.414L10.414 13H15v3a2 2 0 01-2 2H5a2 2 0 01-2-2V5z" />
                                    </svg>
                                    复制
                                </button>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-2 mt-3">
                            <button onclick="copyBase64ToClipboard('${resultId}', '${file.name}')" id="copyBtn-mobile-${resultId}" class="btn btn-primary btn-sm flex items-center sm:hidden shadow-md px-4 py-2.5 text-base">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M8 2a1 1 0 000 2h2a1 1 0 100-2H8z" />
                                    <path d="M3 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v6h-4.586l1.293-1.293a1 1 0 00-1.414-1.414l-3 3a1 1 0 000 1.414l3 3a1 1 0 001.414-1.414L10.414 13H15v3a2 2 0 01-2 2H5a2 2 0 01-2-2V5z" />
                                </svg>
                                复制 Base64
                            </button>
                            <button onclick="downloadBase64AsFile('${resultId}', '${file.name}.txt')" class="btn btn-secondary btn-sm flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                                </svg>
                                下载文本文件
                            </button>
                        </div>
                    `;
                    
                    base64ResultsContainer.appendChild(resultItem);
                    filesProcessedCount++;
                    totalProcessed++;
                    
                    // Update the processing indicator with progress bar
                    document.getElementById('processedCount').textContent = totalProcessed;
                    const progressPercent = (totalProcessed / files.length) * 100;
                    const progressBar = document.getElementById('progress-bar');
                    if (progressBar) {
                        progressBar.style.width = `${progressPercent}%`;
                    }
                    
                    if (filesProcessedCount === files.length) {
                        // Remove processing indicator
                        const processingIndicator = document.getElementById('processingIndicator');
                        if (processingIndicator) {
                            processingIndicator.remove();
                        }
                        
                         showMessage('success', `${files.length} 个文件已成功编码为 Base64。`);
                    }
                };
                
                reader.onerror = function() {
                    showMessage('error', `读取文件 "${file.name}" 失败。`);
                    filesProcessedCount++;
                    totalProcessed++;
                    
                    // Update the processing indicator
                    document.getElementById('processedCount').textContent = totalProcessed;
                    
                     if (filesProcessedCount === files.length) {
                        // Remove processing indicator
                        const processingIndicator = document.getElementById('processingIndicator');
                        if (processingIndicator) {
                            processingIndicator.remove();
                        }
                        
                         showMessage('info', `部分文件处理完成，部分失败。`, 'info');
                    }
                };
                
                // Add a small delay between file processing for smoother UX
                setTimeout(() => {
                reader.readAsArrayBuffer(file);
                }, i * 100);
            }
        }
        
        clearBase64ResultsBtn.addEventListener('click', () => {
            base64ResultsContainer.innerHTML = '';
            base64ResultsContainer.classList.add('hidden');
            clearBase64ResultsBtn.classList.add('hidden');
            document.getElementById('base64FileNames').textContent = ''; // Clear file names display
            document.getElementById('base64FilesInput').value = ''; // Clear the actual file input
            showMessage('info', 'Base64 结果已清除。', 'info');
        });

        window.copyBase64ToClipboard = function(elementId, fileName) {
            const textarea = document.getElementById(elementId);
            const copyBtn = document.getElementById(`copyBtn-${elementId}`);
            const mobileCopyBtn = document.getElementById(`copyBtn-mobile-${elementId}`);
            const originalBtnText = copyBtn.innerHTML;
            const originalMobileBtnText = mobileCopyBtn ? mobileCopyBtn.innerHTML : '';
            
            if (!textarea) { 
                showMessage('error', `无法找到 Base64 内容: ${elementId}`, 'copy'); 
                return; 
            }
            
            textarea.select();
            textarea.setSelectionRange(0, 99999); // For mobile devices
            
            try {
                document.execCommand('copy'); // Deprecated but common
                
                // Show success in the buttons
                copyBtn.classList.add('copy-btn-success');
                copyBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                    </svg>
                    已复制!
                `;
                
                if (mobileCopyBtn) {
                    mobileCopyBtn.classList.add('copy-btn-success');
                    mobileCopyBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                        </svg>
                        已复制!
                    `;
                }
                
                showMessage('success', `文件 "${fileName}" 的 Base64 已复制到剪贴板。`, 'copy');
                
                // Reset buttons after 2s
                setTimeout(() => {
                    copyBtn.classList.remove('copy-btn-success');
                    copyBtn.innerHTML = originalBtnText;
                    
                    if (mobileCopyBtn) {
                        mobileCopyBtn.classList.remove('copy-btn-success');
                        mobileCopyBtn.innerHTML = originalMobileBtnText;
                    }
                }, 2000);
                
            } catch (err) {
                // Fallback for browsers that don't support execCommand or if it fails
                navigator.clipboard.writeText(textarea.value).then(() => {
                    // Show success in the buttons
                    copyBtn.classList.add('copy-btn-success');
                    copyBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                        </svg>
                        已复制!
                    `;
                    
                    if (mobileCopyBtn) {
                        mobileCopyBtn.classList.add('copy-btn-success');
                        mobileCopyBtn.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                            </svg>
                            已复制!
                        `;
                    }
                    
                    showMessage('success', `文件 "${fileName}" 的 Base64 已复制到剪贴板。`, 'copy');
                    
                    // Reset buttons after 2s
                    setTimeout(() => {
                        copyBtn.classList.remove('copy-btn-success');
                        copyBtn.innerHTML = originalBtnText;
                        
                        if (mobileCopyBtn) {
                            mobileCopyBtn.classList.remove('copy-btn-success');
                            mobileCopyBtn.innerHTML = originalMobileBtnText;
                        }
                    }, 2000);
                    
                }).catch(clipErr => {
                    showMessage('error', `复制失败: ${clipErr}`, 'copy');
                });
            }
            
            if (window.getSelection) { // Deselect
              window.getSelection().removeAllRanges();
            } else if (document.selection) { // IE
              document.selection.empty();
            }
        }
        
        window.downloadBase64AsFile = function(elementId, fileName) {
            const textarea = document.getElementById(elementId);
            if (!textarea) {
                showMessage('error', `无法找到 Base64 内容: ${elementId}`);
                return;
            }
            
            const base64String = textarea.value;
            const blob = new Blob([base64String], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showMessage('success', `Base64 内容已下载为 "${fileName}"`);
        }
        
        window.deleteBase64Result = function(element) {
            element.classList.add('animate-fade-out');
            setTimeout(() => {
                element.remove();
                
                // If no more results, hide container and button
                if (base64ResultsContainer.children.length === 0) {
                    base64ResultsContainer.classList.add('hidden');
                    clearBase64ResultsBtn.classList.add('hidden');
                }
            }, 300);
        }
        
        // Add fade-out animation
        const fadeOutStyle = document.createElement('style');
        fadeOutStyle.textContent = `
            @keyframes fadeOut {
                0% { opacity: 1; transform: translateY(0); }
                100% { opacity: 0; transform: translateY(-10px); }
            }
            .animate-fade-out {
                animation: fadeOut 0.3s ease-in forwards;
            }
        `;
        document.head.appendChild(fadeOutStyle);

        document.addEventListener('DOMContentLoaded', (event) => {
            prefillStep1Inputs();
            
            // Set step 1 as active without checkmarks
            step1Circle.classList.remove('step-active', 'step-complete', 'step-inactive');
            step1Circle.classList.add('step-active');
            step1Circle.innerHTML = '';
            
            step2Circle.classList.remove('step-active', 'step-complete', 'step-inactive');
            step2Circle.classList.add('step-inactive');
            step2Circle.innerHTML = '';
            
            step3Circle.classList.remove('step-active', 'step-complete', 'step-inactive');
            step3Circle.classList.add('step-inactive');
            step3Circle.innerHTML = '';
            
            // Make the lines inactive
            line1_2.classList.remove('step-line-active');
            line1_2.classList.add('step-line-inactive');
            
            line2_3.classList.remove('step-line-active');
            line2_3.classList.add('step-line-inactive');
        });
    </script>
</body>
</html>
